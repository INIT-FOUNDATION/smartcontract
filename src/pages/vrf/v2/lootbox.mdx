---
layout: ../../../layouts/MainLayout.astro
section: vrf
title: "Create a lootbox to distribute random rewards"
---

import { Aside } from "@components"
import { Tabs } from "@components/Tabs"

The lootbox is a utility contract that uses Chainlink VRF to determine a random reward. The user receives the reward after opening the contract.

It supports [ERC-20](https://eips.ethereum.org/EIPS/eip-20), [ERC-721](https://eips.ethereum.org/EIPS/eip-721), and [ERC-1155](https://eips.ethereum.org/EIPS/eip-1155) tokens as rewards. The rewards are distributed from a pool of tokens that are transferred to the contract when the lootbox contract is deployed.

<Aside type="caution" title="Disclaimer">
  This repository represents an example of using a Chainlink product or service. It is provided to to help you
  understand how to interact with Chainlink's systems so that you can integrate them into your own. This template is
  provided "AS IS" without warranties of any kind, has not been audited, and may be missing key checks or error handling
  to make the usage of the product more clear. Take everything in this repository as an example and not something to be
  copy pasted into a production ready service.
</Aside>

## Before you begin

Before you start this tutorial, complete the following items:

- Install [git](https://git-scm.com/book/en/v2/Getting-Started-Installing-Git)
  - To check your installation, run `git --version`. You should see an output similar to `git version x.x.x`.
- Install [Nodejs](https://nodejs.org/en/) 16.0.0 or higher
  - To check your installation, run `node --version`. You should see an output similar to `v16.x.x`.
- Ensure the deployer account has enough LINK to fund the [VRF subscription](/vrf/v2/subscription). If you don't already have a VRF subscription, the deployment script will create one for you.
  - [Estimate the minimum subscription balance](/vrf/v2/estimating-costs#estimate-minimum-subscription-balance) that VRF requires to process your randomness request. The minimum subscription balance provides a buffer against gas volatility, and only the actual cost of your request will be deducted from your account. If your subscription is underfunded, your VRF request will be pending for 24 hours. If that happens, check the [Subscription Manager](https://vrf.chain.link]) to see the additional balance needed.
  - Configure the initial funding amount in [`network-config.ts`](https://github.com/smartcontractkit/quickstarts-lootbox/blob/main/network-config.ts).
  - To deploy this contract on testnets, use the [LINK faucet](https://faucets.chain.link/) to retrieve testnet LINK. Request 20 LINK from the faucet - this amount should be sufficient to run this tutorial on a testnet.

## Setup steps

This tutorial requires you to set up two primary components:

- [Install dependencies](#install-dependencies)
- [Configuration](#configuration)

### Install dependencies

Clone the repo and install all dependencies.

<Tabs client:visible>
<Fragment slot="tab.1">npm</Fragment>
<Fragment slot="tab.2">yarn</Fragment>
<Fragment slot="panel.1">
```bash
git clone git@github.com:hackbg/chainlink-solutions-lootbox.git

cd chainlink-solutions-lootbox

npm install

````
</Fragment>
<Fragment slot="panel.2">
Alternatively, you can use [yarn](https://yarnpkg.com/) to install dependencies.

```bash
git clone git@github.com:hackbg/chainlink-solutions-lootbox.git

cd chainlink-solutions-lootbox

yarn install
````

</Fragment>
</Tabs>

### Configuration

Copy the `.env.example` file to `.env` and fill in the values.

```bash
cp .env.example .env
```

#### Hardhat project

[Hardhat](https://hardhat.org/) is an Ethereum development environment that is used here to configure and deploy the lootbox contract.

1. In your `.env` file, fill in these values:

   | Parameter         | Description                                                 | Example                                     |
   | ----------------- | ----------------------------------------------------------- | ------------------------------------------- |
   | `NETWORK_RPC_URL` | The RPC URL for the network you want to deploy to.          | `https://sepolia.infura.io/v3/your-api-key` |
   | `PRIVATE_KEY`     | The private key of the account you want to deploy from.     | `0xabc123abc123abc123abc123abc123...`       |
   | `ETHERSCAN_API`   | The API key for Etherscan needed for contract verification. | `ABC123ABC123ABC123ABC123ABC123ABC1`        |

1. Configure your deployment network in [`hardhat.config.ts`](https://github.com/smartcontractkit/quickstarts-lootbox/blob/main/hardhat.config.ts).

#### Contract parameters

In your `.env` file, fill in these values:

| Parameter                             | Description                                                                                                               | Example      |
| ------------------------------------- | ------------------------------------------------------------------------------------------------------------------------- | ------------ |
| `LOOTBOX_FEE_PER_OPEN`                | The fee per open in ETH                                                                                                   | `0.1`        |
| `LOOTBOX_AMOUNT_DISTRIBUTED_PER_OPEN` | The amount of reward units distributed per open                                                                           | `1`          |
| `LOOTBOX_OPEN_START_TIMESTAMP`        | The start timestamp in UNIX time for the public open. Leave blank to start immediately.                                   | `1630000000` |
| `VRF_SUBSCRIPTION_ID`                 | A funded Chainlink VRF subscription ID. If you leave this blank, a new subscription will be created and funded on deploy. | `123`        |

#### Reward tokens

For rewards, the lootbox contracts supports any tokens from the following [token standards](https://ethereum.org/en/developers/docs/standards/tokens/):

- [ERC-20](https://ethereum.org/en/developers/docs/standards/tokens/erc-20/): the fungible token standard
- [ERC-721](https://ethereum.org/en/developers/docs/standards/tokens/erc-721/): the NFT standard
- [ERC-1155](https://ethereum.org/en/developers/docs/standards/tokens/erc-1155/): the multi-token standard

The amounts per unit are used to calculate the lootbox supply of rewards. For example, if you want to distribute 100 tokens of a specific ERC-20 token, you would set the `totalAmount` to `100000000000000000000` and the `amountPerUnit` to `1000000000000000000`. This would result in a lootbox supply of 100 units.

Add all the tokens you want to distribute as rewards to the array in the list of tokens by following the format below.

<Aside type="note">The deployer account must own all the tokens you want to distribute as rewards.</Aside>

There's an example configuration file in [`scripts/data/tokens.json`](https://github.com/smartcontractkit/quickstarts-lootbox/blob/main/scripts/data/tokens.json) which includes a list of all supported token types:

<Tabs client:visible>
<Fragment slot="tab.1">ERC-20</Fragment>
<Fragment slot="tab.2">ERC-721</Fragment>
<Fragment slot="tab.3">ERC-1155</Fragment>
<Fragment slot="panel.1">
```json
{
  "tokenType": "ERC20",
  "assetContract": "0x0000000000000000000000000000000000000001",
  "totalAmount": "100000000000000000000",
  "amountPerUnit": "10000000"
}
```
</Fragment>
<Fragment slot="panel.2">
```json
{
  "tokenType": "ERC721",
  "assetContract": "0x0000000000000000000000000000000000000002",
  "tokenIds": ["1", "2"]
}
```
</Fragment>
<Fragment slot="panel.3">
```json
{
  "tokenType": "ERC1155",
  "assetContract": "0x0000000000000000000000000000000000000003",
  "tokenId": "0",
  "totalAmount": "100",
  "amountPerUnit": "10"
}
```
</Fragment>
</Tabs>

#### Allow list for private mints

The [Merkle tree](https://ethereum.org/en/developers/tutorials/merkle-proofs-for-offline-data-integrity/#introduction) for the [private opening mode](#private-mode) is generated from the address list in the [`scripts/data/whitelist.json`](https://github.com/smartcontractkit/quickstarts-lootbox/blob/main/scripts/data/whitelist.json) file. Edit the file and add all the addresses you want to list.

If you don't want to do a private mint, leave the `whitelist.json` file empty, and the contract will be initialized in [public opening mode](#public-mode).

## Run steps

### Test

- To run the unit tests, run the following command:

  ```bash
  npm run test
  ```

- To view gas usage, run the following command:

  ```bash
  REPORT_GAS=true npm run test
  ```

- For coverage reports, run the following command:

  ```bash
  npm run coverage
  ```

### Deploy

To run the deploy script, run the following command and replace `<network>` with the network you want to deploy to. The network must be configured in [`hardhat.config.ts`](https://github.com/smartcontractkit/quickstarts-lootbox/blob/main/hardhat.config.ts).

```bash
npx hardhat run scripts/deploy.js --network <network>
```

Besides deploying the contract, the [deploy script](https://github.com/smartcontractkit/quickstarts-lootbox/blob/main/scripts/deploy.ts) will also:

1.  Approve each token configured in [`scripts/data/tokens.json`](https://github.com/smartcontractkit/quickstarts-lootbox/blob/main/scripts/data/tokens.json) for the deployed contract address.

    This is a mandatory step because the contract must store the tokens in its own balance. It is important to ensure the deployer account owns all the tokens you want to distribute as rewards.

1.  Generate a [Merkle tree](https://ethereum.org/en/developers/tutorials/merkle-proofs-for-offline-data-integrity/#introduction) for the allow list.

1.  Create and fund a VRF subscription if one is not provided.

    {/* prettier-ignore */}
    <Aside type="note">
    Make sure the deployer account has enough LINK to fund the subscription. The initial funding amount is configured in [`network-config.ts`](https://github.com/smartcontractkit/quickstarts-lootbox/blob/main/network-config.ts). For testnets, you can use the [LINK faucet](https://faucets.chain.link/).

    [Estimate the minimum subscription balance](/vrf/v2/estimating-costs#estimate-minimum-subscription-balance) that VRF requires to process your randomness request. The minimum subscription balance provides a buffer against gas volatility, and only the actual cost of your request will be deducted from your account.

    If your subscription is underfunded, your VRF request will be pending for 24 hours. If this happens, check the [Subscription Manager](https://vrf.chain.link]) to see the additional balance needed.

    </Aside>

1.  Add the deployed contract address as a consumer to the VRF subscription.

    If you provided a subscription ID, make sure the deployer account is the owner of the subscription. Otherwise, comment out the `addVrfConsumer` function in the deploy script and add the contract address manually.

1.  Verify the contract on Etherscan. If you want to skip this step, comment out the `verify` function in the deploy script.

## Open the lootbox

Once the contract is deployed and the start timestamp is reached, users can start opening the lootbox. The amount of rewards they receive depends on the amount of units they open by specifying the `amountToOpen` parameter and paying the corresponding fee.

You can control access to the lootbox with two modes: private and public. Use these modes to determine which users can open the lootbox. The owner account can update this setting after deployment, so you can test the opening functionality privately before making the lootbox available to the public.

### Private mode

In this mode, the lootbox is only open to addresses on the allow list by calling the `privateOpen` function and providing Merkle proof for the address. To generate it, see [merkletreejs](https://github.com/merkletreejs/merkletreejs).

The allow list is set on contract deployment and can be changed by calling the `setWhitelistRoot` function from the owner account. The private mode can be enabled or disabled at any time by calling the `setPrivateOpen` function from the owner account.

### Public mode

When the private mode is disabled, anyone can open the lootbox by calling the `publicOpen` function. It will do the same thing as the `privateOpen` function but without the Merkle proof.

## Randomness

The contract uses [Chainlink VRF](https://vrf.chain.link) to generate randomness which is used to determine the rewards the user receives.

Because the randomness is generated off-chain, the contract will not be able to transfer the rewards immediately. Instead, it will store the request and once the randomness is received, the user or anyone else can call the `claimRewards` function to transfer the rewards to the user.

The lootbox creator can also call the `claimRewards` function and improve the user experience by transferring the rewards to the user immediately. You can automate this further by using [Chainlink Automation](https://automation.chain.link/).

## Claim rewards

The rewards for an open request can be claimed by calling the `claimRewards` function and passing the opener address as the parameter. This will transfer the rewards to the opener address.

The claim function can only be called after the randomness is fulfilled. To check this, call the `canClaimRewards` function and pass the opener address as the parameter.

One address can only have one open request at a time. If you try to open the lootbox again before the previous request is fulfilled, the transaction reverts with a `PendingOpenRequest` error.

## Withdraw funds

At any time, the owner can withdraw funds from the collected fees by calling the `withdraw` function. By doing so, the contract balance will be transferred to the owner account.

## Post-deployment configuration

After deployment, you can change some contract parameters by calling the following functions from the owner account:

| Function           | Description                             | Parameters           |
| ------------------ | --------------------------------------- | -------------------- |
| `setWhitelistRoot` | Set new Merkle root for the allow list. | `whitelistRoot`      |
| `setPrivateOpen`   | Enable/disable public opening mode.     | `privateOpenEnabled` |
